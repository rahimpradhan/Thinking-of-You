"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(exports,"__esModule",{value:!0});var _regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_extends2=require("babel-runtime/helpers/extends"),_extends3=_interopRequireDefault(_extends2),_slicedToArray2=require("babel-runtime/helpers/slicedToArray"),_slicedToArray3=_interopRequireDefault(_slicedToArray2),_objectWithoutProperties2=require("babel-runtime/helpers/objectWithoutProperties"),_objectWithoutProperties3=_interopRequireDefault(_objectWithoutProperties2),_asyncToGenerator2=require("babel-runtime/helpers/asyncToGenerator"),_asyncToGenerator3=_interopRequireDefault(_asyncToGenerator2),_promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),_getPrototypeOf=require("babel-runtime/core-js/object/get-prototype-of"),_getPrototypeOf2=_interopRequireDefault(_getPrototypeOf),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_possibleConstructorReturn2=require("babel-runtime/helpers/possibleConstructorReturn"),_possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2),_inherits2=require("babel-runtime/helpers/inherits"),_inherits3=_interopRequireDefault(_inherits2),_react=require("react"),_react2=_interopRequireDefault(_react),_RestForm=require("redux-simpleform/dist/RestForm"),_RestForm2=_interopRequireDefault(_RestForm),propTypes={endpoint:_react.PropTypes.string.isRequired,testStripeKey:_react.PropTypes.string.isRequired,liveStripeKey:_react.PropTypes.string.isRequired,zeroAmountText:_react.PropTypes.string,stripeNotLoadedText:_react.PropTypes.string,waitText:_react.PropTypes.string,errorText:_react.PropTypes.string,successText:_react.PropTypes.string,welcomeText:_react.PropTypes.string,invalidFieldText:_react.PropTypes.string,setStatus:_react.PropTypes.func.isRequired},defaultProps={zeroAmountText:"Your order is empty",stripeNotLoadedText:"Unfortunately we are unable to process your payment",waitText:"Processing your payment. Please wait ...",errorText:"Houston, we have a problem!",successText:"Your payment has been made",welcomeText:"Please pay for your order",invalidFieldText:"This field is invalid"},StripeForm=function(e){function r(){return(0,_classCallCheck3.default)(this,r),(0,_possibleConstructorReturn3.default)(this,(r.__proto__||(0,_getPrototypeOf2.default)(r)).apply(this,arguments))}return(0,_inherits3.default)(r,e),(0,_createClass3.default)(r,[{key:"componentDidMount",value:function(){r.isStripeLoading||(r.isStripeLoading=!0,setTimeout(function(){var e=document.createElement("script");e.src="https://js.stripe.com/v2/",e.async=!0,document.body.appendChild(e)},500))}},{key:"getStripeToken",value:function(e){return new _promise2.default(function(r,t){Stripe.card.createToken(e,function(e,i){var o=i.error,s=i.id;o?t(o):r(s)})})}},{key:"handleFormWillFetch",value:function(){function e(e){return t.apply(this,arguments)}var t=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(t){var i,o,s,n,a,u,p,l,c;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r.isStripe()){e.next=2;break}throw new Error(this.props.stripeNotLoadedText||"Could not load Stripe.js");case 2:return i=t.number,o=t.cvc,s=t.exp,n=(0,_objectWithoutProperties3.default)(t,["number","cvc","exp"]),a="production"===process.env.NODE_ENV?["live",this.props.liveStripeKey]:["test",this.props.testStripeKey],u=(0,_slicedToArray3.default)(a,2),p=u[0],l=u[1],Stripe.setPublishableKey(l),e.next=13,this.getStripeToken({number:i,cvc:o,exp:s});case 13:return c=e.sent,e.abrupt("return",{mode:p,token:c,data:(0,_extends3.default)({},n,this.props.order)});case 15:case"end":return e.stop()}},e,this)}));return e}()},{key:"handleResponse",value:function(){function e(e){return r.apply(this,arguments)}var r=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(r){var t;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.json();case 2:if(t=e.sent,t.success){e.next=5;break}throw new Error(t.errorMessage||t.message||"Unknown error");case 5:return e.abrupt("return",this.props.successText);case 6:case"end":return e.stop()}},e,this)}));return e}()},{key:"handleParsingComplete",value:function(e){var t=this;return e.map(function(e){switch(e.name){case"number":return e.merge({required:!0,type:"tel",autoComplete:"cc-number",validate:function(e){return r.isStripe()?t.validate(e,Stripe.card.validateCardNumber):e},onChange:function(e,r){return e&&r&&e.length>r.length&&(/^\d{4}$/.test(e)||/^\d{4}\s\d{4}$/.test(e)||/^\d{4}\s\d{4}\s\d{4}$/.test(e))?e+" ":/^[\d\s]*$/.test(e)?e:r}});case"cvc":return e.merge({required:!0,type:"number",autoComplete:"cc-csc",validate:function(e){return r.isStripe()?t.validate(e,Stripe.card.validateCVC):e}});case"exp":return e.merge({required:!0,type:"tel",autoComplete:"cc-exp",validate:function(e){return r.isStripe()?t.validate(e,Stripe.card.validateExpiry):e},onChange:function(e,r){if(e&&r&&e.length>r.length){if(/^\d{2}$/.test(e))return e+"/";if(/^\d{2}\/\/$/.test(e))return r}return/^[\d\/]*$/.test(e)?e:r}})}return e})}},{key:"validate",value:function(e,r){return r(e.value)?e.set("error",!1):e.set("error",!0).set("message",this.props.invalidFieldText)}},{key:"render",value:function(){var e=this.props,r=(e.testStripeKey,e.liveStripeKey,e.zeroAmountText),t=(e.stripeNotLoadedText,e.amountPrefix,e.isDisplayed),i=(e.invalidFieldText,e.order,(0,_objectWithoutProperties3.default)(e,["testStripeKey","liveStripeKey","zeroAmountText","stripeNotLoadedText","amountPrefix","isDisplayed","invalidFieldText","order"]));return t?_react2.default.createElement(_RestForm2.default,(0,_extends3.default)({},i,{onFormWillFetch:this.handleFormWillFetch.bind(this),onResponse:this.handleResponse.bind(this),onParsingComplete:this.handleParsingComplete.bind(this)})):_react2.default.createElement("div",{className:"alert alert-info"},_react2.default.createElement("p",null,r))}}],[{key:"isStripe",value:function(){return"undefined"!=typeof Stripe}}]),r}(_react.Component);StripeForm.isStripeLoading=!1,StripeForm.propTypes=propTypes,StripeForm.defaultProps=defaultProps,exports.default=StripeForm,module.exports=exports.default;