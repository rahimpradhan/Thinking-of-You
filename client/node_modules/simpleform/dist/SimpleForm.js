"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(exports,"__esModule",{value:!0});var _extends2=require("babel-runtime/helpers/extends"),_extends3=_interopRequireDefault(_extends2),_getPrototypeOf=require("babel-runtime/core-js/object/get-prototype-of"),_getPrototypeOf2=_interopRequireDefault(_getPrototypeOf),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_possibleConstructorReturn2=require("babel-runtime/helpers/possibleConstructorReturn"),_possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2),_inherits2=require("babel-runtime/helpers/inherits"),_inherits3=_interopRequireDefault(_inherits2),_react=require("react"),_react2=_interopRequireDefault(_react),_immutable=require("immutable"),_Transition=require("react-overlays/lib/Transition"),_Transition2=_interopRequireDefault(_Transition),_humanize=require("underscore.string/humanize"),_humanize2=_interopRequireDefault(_humanize),_titleize=require("underscore.string/titleize"),_titleize2=_interopRequireDefault(_titleize),propTypes={onSubmit:_react.PropTypes.func,fields:_react.PropTypes.oneOfType([_react.PropTypes.object,_react.PropTypes.array]),className:_react.PropTypes.string,leftClass:_react.PropTypes.string,centralClass:_react.PropTypes.string,rightClass:_react.PropTypes.string,submitText:_react.PropTypes.string,requiredFieldText:_react.PropTypes.string,emptyFieldText:_react.PropTypes.string,dodgyEmailText:_react.PropTypes.string,mandatoryFieldText:_react.PropTypes.string,animationDuration:_react.PropTypes.number,enteringClass:_react.PropTypes.string,leavingClass:_react.PropTypes.string,totalErrorsAnimationDuration:_react.PropTypes.number,totalErrorsEnteringClass:_react.PropTypes.string,totalErrorsLeavingClass:_react.PropTypes.string,noscriptText:_react.PropTypes.string,totalErrorsText:_react.PropTypes.func,onParsingComplete:_react.PropTypes.func,children:_react2.default.PropTypes.node},defaultProps={className:"m-x-1 text-xs-left",leftClass:"col-sm-2",centralClass:"col-sm-5",rightClass:"col-sm-4",submitText:"Submit",requiredFieldText:"Required field",emptyFieldText:"Empty field",dodgyEmailText:"It doesn't look like an email",mandatoryFieldText:"Mandatory fields",animationDuration:1e3,totalErrorsAnimationDuration:400,enteringClass:"simpleform-rotateInDownRight",leavingClass:"simpleform-bounceOutDown",totalErrorsEnteringClass:"simpleform-bounce",totalErrorsLeavingClass:"simpleform-fadeOut",noscriptText:"Please enable javascript in order to use this form.",onSubmit:function(e){console.log(e)},totalErrorsText:function(e){return"There "+(e>1?"are "+e+" errors":"is one error")+" in the form"}},SimpleForm=function(e){function t(){(0,_classCallCheck3.default)(this,t);var e=(0,_possibleConstructorReturn3.default)(this,(t.__proto__||(0,_getPrototypeOf2.default)(t)).call(this));return e.state={},e.onSubmit=e.handleSubmit.bind(e),e.onChange=e.handleChange.bind(e),e.onBlur=e.handleBlur.bind(e),e}return(0,_inherits3.default)(t,e),(0,_createClass3.default)(t,[{key:"parseProps",value:function(e){var t=this,r=(0,_immutable.Record)({id:"",key:"",name:"",required:!1,type:"text",placeholder:"",hint:"",label:"",options:!1,autoComplete:!1,onChange:!1,validate:this.validate.bind(this),value:"",message:!1,error:!1,warning:!1,changed:!1,touched:!1}),a=[];if(e.fields)if(Array.isArray(e.fields))a=e.fields.map(function(e){return"string"==typeof e?{typeStr:e}:e});else for(var s in e.fields)e.fields.hasOwnProperty(s)&&a.push("string"==typeof e.fields[s]?{key:s,typeStr:e.fields[s]}:(0,_extends3.default)({key:s},e.fields[s]));else for(var i in e)!propTypes.hasOwnProperty(i)&&e.hasOwnProperty(i)&&a.push("string"==typeof e[i]?{key:i,typeStr:e[i]}:(0,_extends3.default)({key:i},e[i]));a=a.map(function(e,a){return new r((0,_extends3.default)({},t.parseTypeStr(e.typeStr,e.key),e,{id:a}))}),a=(0,_immutable.List)(a),"function"==typeof this.props.onParsingComplete&&(a=this.props.onParsingComplete(a)),this.setState({fields:a,showErrors:!0})}},{key:"parseTypeStr",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",r=[],a=[];if(e&&"string"==typeof e){a=e.split("|");var s=a[0].split(/[:=]/,2),i=0;s.length>1&&(t=s[0],i=1),r=s[i].match(/\s*([\*\?])?\s*(.*)/i)}var n=r[2]||"text",o=!1;return"["==n[0]?(o=n.slice(1,-1).split(","),n="options"):/^\d+$/.test(n)&&(o=n,n="textarea"),{name:t,required:"*"===r[1],type:n,options:o,placeholder:a[1]||"",hint:a[2],label:a[3]||(0,_titleize2.default)((0,_humanize2.default)(t),!1),value:a[4]||""}}},{key:"componentWillMount",value:function(){this.parseProps(this.props)}},{key:"handleBlur",value:function(e){var t=e.target,r=t.getAttribute("data-id"),a=this.state.fields.get(r),s=a.changed,i=a.touched;s&&!i&&this.setState({fields:this.state.fields.update(r,function(e){return e.set("touched",!0)})})}},{key:"handleChange",value:function(e){var t=e.target,r=t.getAttribute("data-id"),a=t.value,s=t.type;"number"===s&&+a<0||this.setState(function(e){var t=e.fields;return{fields:t.update(r,function(e){return"function"==typeof e.onChange&&(a=e.onChange(a,e.value)),"options"===e.type&&(a=e.value!==a&&a),e.changed||(e=e.set("changed",!0)),e.validate(e.set("value",a))})}})}},{key:"handleSubmit",value:function(e){var t=this;e.preventDefault();var r=this.state.fields.map(function(e){return t.validate(e.set("touched",!0))});r.reduce(function(e,t){var r=t.error;return r?e+1:e},0)||this.props.onSubmit(r.map(function(e){var t=e.name,r=e.value;return[t,r]}).fromEntrySeq().toJS()),this.setState({showErrors:!1},function(){return setTimeout(function(){return t.setState((0,_extends3.default)({},t.state,{fields:r,showErrors:!0}))},t.props.totalErrorsAnimationDuration)})}},{key:"validate",value:function(e){var t=e.value,r=e.required,a=e.type,s=!(!r||t)&&this.props.requiredFieldText,i=!t&&!("options"===e.type&&1===e.options.length)&&this.props.emptyFieldText||"email"===a&&!/^[a-zA-Z0-9_.+-]+@[a-zA-Z0-9-]+\.[a-zA-Z0-9-.]+$/.test(t)&&this.props.dodgyEmailText;return e.set("error",!!s).set("warning",!!i).set("message",s||i||e.message)}},{key:"renderOptions",value:function(e,t){var r=this;return e.options.map(function(a){return _react2.default.createElement("label",{key:a,className:"form-check-inline form-control-static"},_react2.default.createElement("input",(0,_extends3.default)({},t,{className:"form-check-input",type:"checkbox",checked:r.state.fields.get(e.id).value===a,value:a})),a)})}},{key:"inputGroup",value:function(e,t){return _react2.default.createElement("div",{className:"input-group"},_react2.default.createElement("span",{className:"input-group-addon"},e),t,_react2.default.createElement("span",{className:"input-group-addon"},".00"))}},{key:"renderField",value:function(e,t){var r={className:"form-control"+t,onChange:this.onChange,onBlur:this.onBlur,value:e.value,"data-id":e.id};switch(e.autoComplete&&(r.autoComplete=e.autoComplete),e.type){case"$":case"£":return this.inputGroup(e.type,_react2.default.createElement("input",(0,_extends3.default)({},r,{type:"number",placeholder:e.placeholder})));case"textarea":return _react2.default.createElement("textarea",(0,_extends3.default)({},r,{rows:e.options,placeholder:e.placeholder}));case"date":return _react2.default.createElement("input",(0,_extends3.default)({},r,{type:"date",style:{minHeight:"2.375rem"},placeholder:"dd/mm/yyyy"}));case"options":return this.renderOptions(e,r);default:return _react2.default.createElement("input",(0,_extends3.default)({},r,{type:e.type,placeholder:e.placeholder}))}}},{key:"formRow",value:function(e){var r=e.label,a=e.hint,s=(e.type,e.error),i=e.warning,n=e.touched,o=(e.name,""),l="",u=!1;return n&&(l=s?"danger":i?"warning":"success",o+=" has-"+l,l=" form-control-"+l,u=s||i),_react2.default.createElement("div",{className:"form-group row"+o,key:e.id},_react2.default.createElement("label",{className:"col-xs-12 text-sm-right col-form-label "+this.props.leftClass},(e.required?"*":"")+r),_react2.default.createElement("div",{className:"col-xs-12 "+this.props.centralClass+o+("options"===e.type?" checkbox":"")},this.renderField(e,l),a?_react2.default.createElement("small",{className:"form-text text-muted"},a):void 0),_react2.default.createElement(_Transition2.default,{style:t.animate(this.props.animationDuration),in:!!u,timeout:this.props.animationDuration,enteringClassName:this.props.enteringClass,exitingClassName:this.props.leavingClass,unmountOnExit:!0,transitionAppear:!0},_react2.default.createElement("div",{className:"col-xs-12 "+this.props.rightClass},_react2.default.createElement("div",{className:"form-control-static text-muted"},e.message))))}},{key:"footer",value:function(){var e=!1,r=this.state.fields.reduce(function(t,r){var a=r.error,s=r.required,i=r.touched;return s&&!e&&(e=!0),a&&i?t+1:t},0);return _react2.default.createElement("div",{className:"form-group row"+(r?" has-danger":"")},_react2.default.createElement("div",{className:"col-xs-12 "+this.props.leftClass},e?_react2.default.createElement("small",{className:"form-text text-muted text-sm-right form-control-static"},"*",this.props.mandatoryFieldText):void 0),_react2.default.createElement("div",{className:"col-xs-12 form-inline col-sm-8"},_react2.default.createElement("div",{className:"form-group has-danger"},_react2.default.createElement("button",{type:"submit",className:"btn btn-outline-primary"},this.props.submitText),_react2.default.createElement("div",{className:"text-muted form-control-static"},"   "),_react2.default.createElement(_Transition2.default,{style:t.animate(this.props.totalErrorsAnimationDuration),timeout:this.props.totalErrorsAnimationDuration,in:this.state.showErrors&&r>0,enteringClassName:this.props.totalErrorsEnteringClass,exitingClassName:this.props.totalErrorsLeavingClass,unmountOnExit:!0,transitionAppear:!0},_react2.default.createElement("div",{className:"text-muted form-control-static"},this.props.totalErrorsText(r))))))}},{key:"render",value:function(){var e=this;return _react2.default.createElement("form",{noValidate:!0,onSubmit:this.onSubmit,className:this.props.className,style:{overflow:"hidden"}},_react2.default.createElement("noscript",null,this.props.noscriptText),this.state.fields.map(function(t){return e.formRow(t)}),this.footer())}}],[{key:"animate",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1e3;return{WebkitAnimationDuration:e/1e3+"s",animationDuration:e/1e3+"s",WebkitAnimationFillMode:"both",animationFillMode:"both"}}}]),t}(_react.Component);SimpleForm.propTypes=propTypes,SimpleForm.defaultProps=defaultProps,exports.default=SimpleForm,module.exports=exports.default;